var _obj,_href=window.location.href,_len=0,_page=1,_content,_place,_send,_join,_guestNum,_guestList,_readMore,_addOne,_CG="cloudui-guestbook",_htmlGuestbook='<div class="cloudui-guestbook-title"><span><a href="http://member.123.com.cn?service='+window.location.href+'" target="_self">登录</a><span class="info-line">|</span><a href="http://member.123.com.cn/home/register.html" target="_blank">5秒注册</a></span><strong>网友评论 (<em id="cloudui-guestbook-join">0</em>人参与，<em class="cloudui-guestbook-guestnum">0</em>人评论)</strong></div>';_htmlGuestbook+='<div class="cloudui-guestbook-textarea"><div class="cloudui-textarea"><div class="cloudui-guestbook-icon"><img src="http://cdn.static.123.com.cn/CloudStatic/cloudui/img/nophoto.gif" /></div><label id="cloudui-guestbook-content-placeholder">文明上网，理性发帖</label><textarea class="cloudui-guestbook-con"></textarea><div class="zi-num">0/300</div></div></div><div class="cloudui-guestbook-btnbar"><button class="cloudui-guestbook-send" disabled="disabled">发表评论</button></div>',_htmlGuestbook+='<div class="cloudui-guestbook-loading"><img src="http://cdn.static.123.com.cn/CloudStatic/cloudui/img/loading.gif"></div><div class="cloudui-guestbook-list"><div class="cloudui-guestbook-list-title"><strong>全部评论(<em class="cloudui-guestbook-guestnum">0</em>)</strong></div><div id="cloudui-guestbook-list"></div></div>',_htmlGuestbook+='<div class="cloudui-guestbook-readmore"><button class="cloudui-guestbook-unabled">查看后10条评论</button></div><div id="cloudui-guestbook-add-one">+1</div>';var _htmlReply='<div class="cloudui-guestbook-textarea" style="padding-left:0;">';_htmlReply+='<div class="cloudui-guestbook-arrow"></div>',_htmlReply+='<div class="cloudui-textarea"><textarea class="cloudui-guestbook-con"></textarea>',_htmlReply+='<div class="zi-num">0/300</div></div></div>',_htmlReply+='<div class="cloudui-guestbook-btnbar" style="margin-bottom:10px;"><button class="cloudui-guestbook-send" disabled="disabled">发表回复</button></div>',$.extend({clouduiGuestbook:function(a){return _obj=a,!(_obj.length<1)&&void $._GB_check(function(){$._GB_html(),$._GB_guestbook(),$._GB_content(),$._GB_send(),$._GB_readMore(),$._GB_dingCai(),$._GB_reply()})},_GB_check:function(a){$._GB_http("check",{page:_href},function(b){100==b.code&&a()})},_GB_html:function(){var a="";a='<div style="clear:both;"></div>',_obj.before(a).append(_htmlGuestbook),$.ajax({url:"http://sso.123.com.cn/api/ajaxlogin.php",dataType:"jsonp",success:function(a){if(100==a.code){var b;b=null==a.msg.ICON||"http://member.123.com.cn/Public/images/m1.jpg"==a.msg.ICON?"http://cdn.static.123.com.cn/CloudStatic/cloudui/img/nophoto.gif":a.msg.ICON,$("."+_CG+"-title span").html('用户：<a href="http://member.123.com.cn/home/index.html" target="_blank">'+a.msg.NICKNAME+'</a><span class="info-line">|</span><a href="javascript:void(0);" id="cloudui-logout" target="_self">退出</a>'),$("."+_CG+"-textarea").find("img").attr("src",b)}}}),_content=$("."+_CG+"-con"),_send=$("."+_CG+"-send"),_guestNum=$("."+_CG+"-guestnum"),_readMore=$("."+_CG+"-readmore button"),_place=$("#"+_CG+"-content-placeholder"),_join=$("#"+_CG+"-join"),_guestList=$("#"+_CG+"-list"),_addOne=$("#"+_CG+"-add-one")},_GB_guestbook:function(a){var b={};b=void 0!=a?{pagenum:a,page:_href}:{page:_href},$._GB_http("getList",b,function(b){if(void 0==a&&(_join.html(b.msg.JOININ),_guestNum.html(b.msg.GUEST_NUM)),""!=b.msg.GUEST_LIST){var c="";$.each(b.msg.GUEST_LIST,function(a,b){c+=$._GB_guestbookHtml(b),void 0!=b.SON&&$.each(b.SON,function(a,b){c+=$._GB_guestbookHtml(b,!0)}),c+="</div>"}),_guestList.append(c)}b.msg.GUEST_LIST.length<10?_readMore.removeClass(_CG+"-unabled").html("没有更多评论了").attr("disabled",!0):_readMore.html("查看后10条评论"),$("."+_CG+"-list, ."+_CG+"-readmore").show(),$("."+_CG+"-loading").remove()})},_GB_content:function(){_content.focus(function(){""==_content.val()&&_place.hide()}).blur(function(){""==_content.val()&&_place.show()}).live("keyup",function(){$._GB_fontNum($(this))}).live("paste",function(){setTimeout(function(){$._GB_fontNum($(this))},100)})},_GB_send:function(){_send.click(function(){_send.html("保存中...").attr("disabled",!0),$._GB_http("send",{content:_content.val(),page:_href,topid:0},function(a){return $._GB_reset(),!!$._GB_errorMsg(a.code)&&(_join.html(parseInt(_join.html())+1),_guestNum.html(parseInt(_guestNum.html())+1),void _guestList.prepend($._GB_guestbookHtml(a.msg)))})})},_GB_fontNum:function(a){_len=a.val().length,a.next(".zi-num").html(_len+"/300");var b=a.parent().parent().next().children("button");_len>0&&_len<=300?b.hasClass(_CG+"-unabled")||(b.addClass(_CG+"-unabled").attr("disabled",!1),a.next(".zi-num").removeAttr("style")):b.hasClass(_CG+"-unabled")&&(b.removeClass(_CG+"-unabled").attr("disabled",!0),_len>300&&a.next(".zi-num").css("color","red"),0==_len&&a.next(".zi-num").removeAttr("style"))},_GB_reset:function(){_content.val(""),_len=0,_obj.find(".zi-num").html("0/300"),_place.show(),_send.html("发表评论").removeClass(_CG+"-unabled").attr("disabled",!0)},_GB_readMore:function(){_readMore.click(function(){return!!$(this).hasClass(_CG+"-unabled")&&($(this).html("加载中，请稍后..."),_page+=1,$._GB_guestbook(),void 0)})},_GB_dingCai:function(){_guestList.find(".ding,.cai").live("click",function(){if(!$(this).hasClass(_CG+"-unabled")){var a=$(this).offset().top-8,b=$(this).offset().left;_addOne.show().css({top:a,left:b,opacity:1}).animate({top:a-5,opacity:0},400,function(){$(this).hide()});var c=$(this).attr("gid"),d=$(this).attr("class"),e=0,f="";"ding"==d?(e=1,f="顶"):(e=2,f="踩"),$(this).attr("title","您已经"+f+"过啦").addClass(_CG+"-unabled"),$(this).children("span").html(parseInt($(this).children("span").html())+1),_join.html(parseInt(_join.html())+1),$._GB_http(d,{gid:c,page:_href})}})},_GB_reply:function(){var a,b,c;_guestList.find("."+_CG+"-reply").live("click",function(){0==$(this).parent().next("."+_CG+"-textarea").length?(_guestList.find("."+_CG+"-textarea, ."+_CG+"-btnbar").remove(),$(this).parent().parent().append(_htmlReply),a=$(this).parent().next("."+_CG+"-textarea"),b=a.find("."+_CG+"-con"),c=a.next(),b.focus().val("@"+$(this).attr("name")+"：")):a.is(":hidden")?(a.show(),c.show(),b.focus().val("@"+$(this).attr("name")+"：")):(a.hide().find(".zi-num").html("0/300"),c.hide().children("button").removeClass(_CG+"-unabled")),_gid=$(this).attr("gid"),c.children("button").unbind("click").click(function(){if(0==_len)return b.focus(),!1;$(this).html("保存中...").attr("disabled",!0);var d=$(this),e=b.val();$._GB_http("send",{content:e,page:_href,topid:_gid},function(e){if(d.html("发表回复").removeClass(_CG+"-unabled").attr("disabled",!0),b.val(""),_len=0,a.hide().find(".zi-num").html("0/300"),c.hide(),!$._GB_errorMsg(e.code))return!1;var f=$._GB_guestbookHtml(e.msg,!0);$(".reply-"+_gid).parent().parent().after(f),_join.html(parseInt(_join.html())+1);var g=a.prev().children("."+_CG+"reply").children("span");g.html(parseInt(g.html())+1)})})})},_GB_http:function(a,b,c){$.ajax({async:!1,url:"http://sso.123.com.cn/app/guestbook.php?action="+a,type:"GET",dataType:"jsonp",jsonp:"callback",data:b,timeout:3e3,success:function(a){void 0!=c&&c(a)}})},_GB_guestbookHtml:function(a,b){var c="";c+='<div class="'+_CG+'-list-box">',c+='<div class="'+_CG+'-list-box-right">',c+='<div class="'+_CG+'-icon">',c+='<img src="'+a.ICON+'" />',c+="</div>",c+='<div class="'+_CG+'-name-addtime">',c+='<span class="'+_CG+'-addtime">'+a.ADDTIME+"</span>",c+='<span class="'+_CG+'-name">'+a.NICKNAME+"</span>",c+="</div>",c+='<div class="'+_CG+'-content">',c+=a.CONTENT,c+="</div>",c+='<div class="'+_CG+'-btn-bar">',c+='<a href="javascript:void(0);" title="顶" gid="'+a.ID+'" class="ding" target="_self">顶(<span>'+a.DING+"</span>)</a>",c+='<a href="javascript:void(0);" title="踩" gid="'+a.ID+'" class="cai" target="_self">踩(<span>'+a.CAI+"</span>)</a>";var d=void 0!=b&&1==b?a.TOPID:a.ID;return c+='<a href="javascript:void(0);" title="回复" class="'+_CG+"-reply reply-"+a.ID+'" gid="'+d+'" name="'+a.NICKNAME+'" target="_self">回复(<span>'+a.REPLY_NUM+"</span>)</a>",c+=void 0!=b&&1==b?"</div></div></div>":"</div></div>"},_GB_errorMsg:function(a){return 0!=a&&(1==a?(alert("亲，这句话您已经说过很多遍了哦！"),!1):2==a?(alert("实验证明，评论速度太快可能导致键盘冒烟！"),!1):3==a?(alert("您的评论内容过长"),!1):4!=a||(alert("您的账号已被禁止评论！"),!1))}});