var date=new Date,DP="cloudui-datepicker",isFocus=!1;$.extend({clouduiDatepicker:function(a,b,c){var d,e,f,g,h,j,k,l,m=!(void 0==b.his||!b.his),n=!(void 0==b.doublePicker||!b.doublePicker),c=a.replace("#","",a);c=c.replace(".","",c),d=date.getFullYear(),e=date.getMonth(),_showM=_repairZero(parseInt(e)+1),f=date.getDate(),f=_repairZero(f),$("body").on("focus",a,function(){if(l=$(this),0==$("."+DP+"-"+c).length){var a,o=void 0==b.borderColor?"#DDD":b.borderColor;for(n?(a='<div class="'+DP+"-box "+DP+"-box-double "+DP+"-"+c+'" style="border:1px '+o+' solid;">',a+='<p class="'+DP+'-choosed">当前选择的日期：<em>'+d+"/"+_showM+"/"+f+"</em> - <em>"+d+"/"+_showM+"/"+f+"</em></p>",a+='<p class="'+DP+'quick-choose-date">',a+="<em>三天内</em><span></span>",a+="<em>一周内</em><span></span>",a+="<em>一月内</em><span></span>",a+="<em>一年内</em><span></span>",a+="<em>三天后</em><span></span>",a+="<em>一周后</em><span></span>",a+="<em>一月后</em><span></span>",a+="<em>一年后</em></p>",a+="</div>"):a='<div class="'+DP+"-box "+DP+"-"+c+'"></div>',$("body").append(a),k=$("."+DP+"-"+c),a="",a+=n?'<div><table class="'+DP+'">':'<table class="'+DP+'" style="border:1px '+o+' solid;">',a+="<tr>",a+='<td colspan="7" class="'+DP+'-toolbar">',a+='<select class="'+DP+'-change-year">',i=d+10;i>=1970;i--)a+='<option value="'+i+'"',i==d&&(a+=' selected="selected"'),a+=">"+i+"</option>";for(a+="</select> 年 ",a+='<select class="'+DP+'-change-month">',i=1;i<13;i++)i=_repairZero(i),a+='<option value="'+i+'"',e+1==i&&(a+=' selected="selected"'),a+=">"+i+"</option>";a+="</select> 月 ",a+="</td></tr>",a+='<tr class="'+DP+'-day">',a+="<td>日</td>",a+="<td>一</td>",a+="<td>二</td>",a+="<td>三</td>",a+="<td>四</td>",a+="<td>五</td>",a+="<td>六</td></tr>",a+='<tbody class="'+DP+'-date">',a+=$._createYmdHtml(d,e,f),a+="</tbody>",n||(a+='<tr><td colspan="7" class="'+DP+'-btnbar" style="border-top-color:'+o+'">',m?(g=date.getHours(),g=_repairZero(g),h=date.getMinutes(),h=_repairZero(h),j=date.getSeconds(),j=_repairZero(j),a+='<input class="'+DP+'-h" value="'+g+'">：<input class="'+DP+'-i" value="'+h+'">：<input class="'+DP+'-s" value="'+j+'">',a+="<button>确定</button>"):a+="<span>选择今天：<em>"+d+"-"+_showM+"-"+f+"</em></span>",a+="</td></tr>"),a+="</table>",n&&(a+="</div>",a+=a,a+='<div class="clear"></div>',a+='<p class="btnbar"><button>确定</button><button class="cancel">取消</button></p>'),n?k.append(a):k.html(a),k.show().find("."+DP+"-change-year, ."+DP+"-change-month").change(function(){$._jumpdate($(this).parent().parent().parent().parent(),f)})}else k=$("."+DP+"-"+c),m&&(g=(new Date).getHours(),g=_repairZero(g),h=(new Date).getMinutes(),h=_repairZero(h),j=(new Date).getSeconds(),j=_repairZero(j),k.find("."+DP+"-h").val(g),k.find("."+DP+"-i").val(h),k.find("."+DP+"-s").val(j)),k.show();if(""!=l.val()){var p=l.val();if(n){var q=p.split("-"),r=q[0].split("/"),s=q[1].split("/");if(3==r.length){var t=r[0],u=r[1];k.find("."+DP+"-date").eq(0).html($._createYmdHtml(t,u-1,r[2]));var v=k.find("."+DP+"-change-year").eq(0),w=k.find("."+DP+"-change-month").eq(0);v.val(t),w.val(u)}if(3==s.length){var t=s[0],u=s[1];k.find("."+DP+"-date").eq(1).html($._createYmdHtml(t,u-1,s[2]));var v=k.find("."+DP+"-change-year").eq(1),w=k.find("."+DP+"-change-month").eq(1);v.val(t),w.val(u)}}else{var q=p.split("-");if(3==q.length){var t=q[0],u=q[1];k.find("."+DP+"-date").html($._createYmdHtml(t,u-1,q[2]));var v=k.find("."+DP+"-change-year"),w=k.find("."+DP+"-change-month");v.val(t),w.val(u)}}}k.unbind("mouseenter").mouseenter(function(){isFocus=!0}).unbind("mouseleave").mouseleave(function(){isFocus=!1}),k.children("."+DP).width(l.outerWidth());var x=k.outerHeight(),y=l.offset().top;if(_innerH()-(y-$(document).scrollTop())-l.outerHeight()<x?k.css("top",y-x+1):k.css("top",y+l.outerHeight()-1),k.css("left",l.offset().left),n){k.find("."+DP+"-date").unbind("click").on("click","td",function(){if($(this).hasClass(DP+"-disabled"))return!1;var a=$(this).parent().parent(),b=k.find("."+DP+"-date").index(a);a.find("."+DP+"-checked").removeClass(DP+"-checked"),$(this).addClass(DP+"-checked");var c=k.find("."+DP+"-choosed em").eq(b),d=a.prev(),e=d.find("."+DP+"-change-year").val()+"/"+d.find("."+DP+"-change-month").val()+"/"+$(this).html();c.html(e)});var z=k.find("."+DP+"quick-choose-date em");z.unbind("click").click(function(){var a=$(this).html();switch(a){case"三天内":$._getDate(3,0,k,d,_showM,f);break;case"一周内":$._getDate(7,0,k,d,_showM,f);break;case"一月内":$._getDate(30,0,k,d,_showM,f);break;case"一年内":$._getDate(365,0,k,d,_showM,f);break;case"三天后":$._getDate(3,1,k,d,_showM,f);break;case"一周后":$._getDate(7,1,k,d,_showM,f);break;case"一月后":$._getDate(30,1,k,d,_showM,f);break;case"一年后":$._getDate(365,1,k,d,_showM,f)}}),k.find(".btnbar button").unbind("click").click(function(){if(!$(this).hasClass("cancel")){var a=k.find("."+DP+"-choosed em"),b=a.eq(0).html();b+="-"+a.eq(1).html(),l.val(b)}k.hide()})}else k.find("."+DP+"-date").unbind("click").on("click","td",function(){if($(this).hasClass(DP+"-disabled"))return!1;if(m)$(this).parent().parent().find("."+DP+"-checked").removeClass(DP+"-checked"),$(this).addClass(DP+"-checked");else{var a=k.find("."+DP+"-change-year").val()+"-"+k.find("."+DP+"-change-month").val()+"-"+$(this).html();l.val(a),k.hide(),isFocus=!1}}),m?k.find("."+DP+"-btnbar").children("button").unbind("click").on("click",function(){var a=k.find("."+DP+"-change-year").val()+"-"+k.find("."+DP+"-change-month").val()+"-"+k.find("."+DP+"-checked").html()+" "+k.find("."+DP+"-h").val()+":"+k.find("."+DP+"-i").val()+":"+k.find("."+DP+"-s").val();l.val(a),k.hide(),isFocus=!1}):k.find("."+DP+"-btnbar").children("span").unbind("click").on("click",function(){l.val($(this).children("em").html()),k.hide(),isFocus=!1})}).on("blur",a,function(){isFocus||k.hide()}).on("keyup",a,function(a){13==a.keyCode&&k.find("."+DP+"-checked").trigger("click")}).on("keydown",a,function(a){if(13==a.keyCode)return!1})},_createYmdHtml:function(a,b,c){var d,e,f="",g=new Date(a,b,1).getDay(),h=$._getMonthDay(a,b),j=$._getMonthDay(a,b-1);for(i=0;i<42;i++)0==i?f+="<tr>":i%7==0&&(f+="</tr><tr>"),i<g?(d=j-(g-i)+1,e=' class="'+DP+'-disabled"'):i==g?(d=1,e=i-g+1==c?' class="'+DP+'-checked"':""):i-g+1==c?e=' class="'+DP+'-checked"':i-g+1>h?(i-g-h==0&&(d=1),e=' class="'+DP+'-disabled"'):e="",d=_repairZero(d),f+="<td"+e+">"+d+"</td>",d++;return f},_getMonthDay:function(a,b){b=b<0?11:b;var c=a%4==0&&a%100!=0||a%400==0?29:28,d=new Array;return d[0]=31,d[1]=c,d[2]=31,d[3]=30,d[4]=31,d[5]=30,d[6]=31,d[7]=31,d[8]=30,d[9]=31,d[10]=30,d[11]=31,d[b]},_jumpdate:function(a,b){var c=a.find("."+DP+"-change-year"),d=a.find("."+DP+"-change-month"),e=parseInt(c.val()),f=parseInt(d.val());a.find("."+DP+"-date").html($._createYmdHtml(e,f-1,b))},_getDate:function(a,b,c,d,e,f){var g,h=c.find("."+DP+"-choosed em"),i=c.children("div").not(".clear");g=0==b?Date.parse((new Date).toString())-864e5*a:Date.parse((new Date).toString())+864e5*a;var j=new Date(g),k=j.getFullYear(),l=_repairZero(parseInt(j.getMonth())+1),m=_repairZero(j.getDate());h.eq(b).html(k+"/"+l+"/"+m),i.eq(b).find("."+DP+"-change-year").val(k),i.eq(b).find("."+DP+"-change-month").val(l),$._jumpdate(i.eq(b),m);var n=0==b?1:0;i.eq(n).find("."+DP+"-change-year").val(d),i.eq(n).find("."+DP+"-change-month").val(e),$._jumpdate(i.eq(n),f),h.eq(n).html(d+"/"+e+"/"+f)}});